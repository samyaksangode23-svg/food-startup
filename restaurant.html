<!DOCTYPE html>
<html>
<head>
  <title>Restaurant - Sanghax</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<body>

<div class="app">
  <header class="topbar">
    <h1>SANGHX</h1>
    <span class="role">Restaurant</span>
  </header>

  <main class="content">
    <div class="card">
      <h2>ğŸ³ Restaurant Dashboard</h2>

      <input id="foodName" placeholder="Food Name">
      <input id="price" placeholder="Price">
      <input type="file" id="image">
      <button onclick="uploadMenu()">Upload Menu</button>
      <p id="uploadMsg"></p>

      <h3>ğŸ“¦ Orders</h3>
      <div id="orders"></div>
    </div>
  </main>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="firebase.js"></script>

<script>
  firebase.auth().onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "index.html";
  } else {
    db.collection("users").doc(user.uid).get().then(doc => {
      if (!doc.exists || doc.data().role !== "restaurant") {
        alert("Access denied");
        window.location.href = "index.html";
      }
    });
  }
});

const storage = firebase.storage();

function uploadMenu(){
  const name = document.getElementById("foodName").value;
  const cost = document.getElementById("price").value;
  const file = document.getElementById("image").files[0];

  if(!name || !cost || !file){
    alert("Fill all fields");
    return;
  }

  const storageRef = firebase.storage().ref("menu/" + Date.now() + "_" + file.name);

  storageRef.put(file)
    .then(() => storageRef.getDownloadURL())
    .then(url => {
      return db.collection("menu").add({
        name: name,
        price: cost,
        image: url
      });
    })
    .then(() => {
      document.getElementById("uploadMsg").innerText = "âœ… Menu uploaded successfully";
      document.getElementById("foodName").value = "";
      document.getElementById("price").value = "";
      document.getElementById("image").value = "";
    })
    .catch(err => {
      alert("Error: " + err.message);
      console.error(err);
    });
}

db.collection("orders")
.where("status","==","Pending")
.orderBy("time","desc")
.onSnapshot(snapshot=>{
  let html = "";
  snapshot.forEach(doc=>{
    const o = doc.data();
    html += `
      <div class="order">
        <b>${o.food}</b><br>
        ${o.name} - ${o.mobile}<br>
        ${o.address}<br>
        Status: <span class="status ${o.status}">${o.status}</span><br>
        <button onclick="updateStatus('${doc.id}','Preparing')">Accept</button>
        <button onclick="updateStatus('${doc.id}','Rejected')">Reject</button>
      </div>`;
  });
  orders.innerHTML = html;
});

function updateStatus(id,status){
  db.collection("orders").doc(id).update({status});
}
</script>
</body>
</html>